# 🚀 일괄 AI 분석 가이드

## 개요
모든 종목의 시그널 발생일에 대해 AI 분석을 일괄 조회하고 캐싱하는 기능입니다.

## 사용 방법

### 1. 기본 사용 (전체 종목)

```bash
python3 batch_analyze_all.py
```

전체 약 80개 종목을 분석합니다. 소요 시간: 약 3-4분

### 2. 특정 종목만 분석

```bash
python3 batch_analyze_all.py --tickers "AAPL,MSFT,GOOGL,TSLA,NVDA"
```

### 3. API 호출 간격 조정

```bash
python3 batch_analyze_all.py --delay 3
```

기본값은 2초입니다. API 제한이 있다면 3초 이상으로 설정하세요.

### 4. 쉘 스크립트로 실행

```bash
./run_full_batch.sh
```

확인 프롬프트와 함께 전체 종목을 분석합니다.

## 작동 방식

1. **주가 데이터 조회**: 각 종목의 최근 6개월 주가 데이터를 가져옵니다.
2. **시그널 분석**: EMA5/EMA20 기반으로 골든크로스/데드크로스 시그널을 찾습니다.
3. **AI 분석 조회**: 시그널 발생일에 대해 Perplexity API로 뉴스 분석을 수행합니다.
4. **자동 캐싱**: 동일한 분석은 데이터베이스에 저장되어 재사용됩니다.

## 출력 예시

```
================================================================================
📊 모든 종목 AI 분석 일괄 조회 및 캐싱
================================================================================

📋 총 5개 종목 분석 시작
⏱️  API 호출 간격: 2초
🕐 예상 소요 시간: 약 0.2분

================================================================================
시작 시간: 2025-12-05 22:54:41
================================================================================

[1/5] NVDA 처리 중...
  📅 시그널: 2025-11-13 (STRONG BUY)
  ✅ 신규 조회 완료

[2/5] TSLA 처리 중...
  📅 시그널: 2025-12-01 (BUY)
  ✅ 신규 조회 완료

...

================================================================================
📊 분석 완료!
================================================================================

⏱️  총 소요 시간: 0.6분

📈 결과 요약:
  - 총 종목 수: 5
  - 신규 조회: 4
  - 캐시 사용: 1
  - 시그널 없음: 0
  - 오류: 0

✅ 성공률: 100.0%
================================================================================
```

## 결과 확인

캐싱된 분석 결과는 Streamlit 앱에서 즉시 확인할 수 있습니다:

```bash
streamlit run app.py
```

각 종목의 차트 expander를 열면 "🤖 AI 시그널 분석" 섹션에서 캐시된 결과가 즉시 표시됩니다.

## 상태별 의미

- **✅ 신규 조회 완료**: API를 호출하여 새로운 분석을 수행하고 캐싱했습니다.
- **✅ 캐시됨**: 이미 분석된 결과를 데이터베이스에서 불러왔습니다.
- **ℹ️ 시그널 발생 내역 없음**: 최근 6개월간 골든크로스/데드크로스가 없습니다.
- **⚠️ 주가 데이터 없음**: yfinance에서 데이터를 가져올 수 없습니다.
- **❌ 분석 실패**: API 오류 또는 네트워크 문제가 발생했습니다.

## 캐시 관리

### 캐시 삭제

```bash
python3 clear_cache.py
```

모든 캐시된 분석 결과를 삭제합니다. 새로운 분석을 다시 받고 싶을 때 사용하세요.

### 캐시 확인

```bash
sqlite3 stock_data.db "SELECT ticker, date, created_at FROM perplexity_analysis ORDER BY created_at DESC LIMIT 10"
```

최근 10개의 캐시된 분석을 확인합니다.

## 주의사항

1. **API 사용량**: Perplexity API는 유료 서비스입니다. 전체 종목 조회 시 약 80회의 API 호출이 발생합니다.

2. **시간 소요**:
   - 전체 종목 (80개): 약 3-4분
   - 10개 종목: 약 30초
   - API 호출 간격을 조정하여 시간을 단축하거나 늘릴 수 있습니다.

3. **중복 방지**: 이미 캐시된 결과는 API를 호출하지 않으므로, 두 번째 실행부터는 훨씬 빠릅니다.

4. **인터럽트**: Ctrl+C로 언제든지 중단할 수 있습니다. 이미 캐싱된 결과는 유지됩니다.

## 고급 사용

### 특정 기간의 시그널만 분석

`batch_analyze_all.py` 파일에서 `get_cached_stock_data` 함수의 `period` 파라미터를 수정하세요:

```python
df = get_cached_stock_data(ticker, period="3mo")  # 3개월로 변경
```

### 병렬 처리 (고급 사용자)

여러 프로세스로 나누어 실행하여 시간을 단축할 수 있습니다:

```bash
# 터미널 1
python3 batch_analyze_all.py --tickers "AAPL,MSFT,GOOGL,TSLA,NVDA" --delay 2

# 터미널 2
python3 batch_analyze_all.py --tickers "AMD,INTC,QCOM,TXN,AVGO" --delay 2
```

## 트러블슈팅

### "API 키 오류" 발생 시
- `.env` 파일에 `PERPLEXITY_API_KEY`가 설정되어 있는지 확인하세요.

### "주가 데이터 없음" 발생 시
- 해당 티커가 유효한지 확인하세요.
- yfinance에서 지원하지 않는 종목일 수 있습니다.

### "분석 실패" 발생 시
- 인터넷 연결을 확인하세요.
- API 사용량 한도를 확인하세요.
- `--delay` 값을 늘려서 재시도하세요.

## 파일 구조

```
stock-analysis-dashboard/
├── batch_analyze_all.py      # 일괄 분석 메인 스크립트
├── run_full_batch.sh          # 실행 헬퍼 스크립트
├── clear_cache.py             # 캐시 삭제 유틸리티
├── stock_data.db              # 캐시 데이터베이스
└── BATCH_ANALYSIS_README.md   # 이 문서
```

## 성능 팁

1. **첫 실행 전**: 중요한 종목만 먼저 분석하세요.
2. **정기 실행**: 매일 한 번씩 실행하여 새로운 시그널을 자동으로 캐싱하세요.
3. **선택적 갱신**: 특정 종목만 재분석하고 싶다면 `clear_cache.py`를 수정하여 해당 종목만 삭제하세요.

## 자동화 (선택사항)

cron으로 매일 자동 실행:

```bash
# crontab -e
0 9 * * 1-5 cd /home/hyeonbeom/stock-analysis-dashboard && python3 batch_analyze_all.py --delay 2
```

매일 오전 9시에 자동으로 모든 종목을 분석합니다.
